<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- SEO核心标签 -->
    <meta charset="UTF-8">
    <title>中医中药书籍搜集大全 - 中医古籍经典在线阅读</title>
    <meta name="description" content="中医中药书籍大全，收录中医经典古籍、中药方剂、中医理论、临床经验等海量中医文本资料，在线流畅阅读">
    <meta name="keywords" content="中医,中药,中医古籍,中医书籍,中药方剂,中医经典,中医理论,中医临床,黄帝内经,伤寒论">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* 全局样式重置与基础设置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        /* 整体样式优化 */
        body {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            font-family: "PingFang SC", "Microsoft YaHei", Arial, sans-serif;
            line-height: 1.8;
            color: #333;
            background-color: #fafafa;
        }
        /* 标题样式 */
        h1 {
            text-align: center;
            margin-bottom: 24px;
            color: #2c3e50;
            font-size: 28px;
            font-weight: 600;
        }
        /* 分页按钮区域 */
        .pagination {
            margin: 20px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }
        .page-btn {
            min-width: 56px;
            padding: 8px 16px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            background: #fff;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-family: inherit;
        }
        .page-btn:hover {
            background: #ecf5ff;
            border-color: #409eff;
            color: #409eff;
        }
        .page-btn.active {
            background: #409eff;
            color: #fff;
            border-color: #409eff;
        }
        /* 编码切换区域 */
        .encoding-switch {
            margin: 12px 0;
            text-align: center;
            font-size: 14px;
            color: #666;
        }
        .encoding-switch select {
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #dcdfe6;
            font-family: inherit;
            cursor: pointer;
        }
        /* 内容展示区域 */
        .content {
            background: #fff;
            padding: 24px;
            border-radius: 8px;
            border: 1px solid #ebeef5;
            white-space: pre-wrap;
            overflow-wrap: break-word;
            max-height: 70vh;
            overflow-y: auto;
            font-size: 16px;
            color: #333;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.05);
        }
        /* 加载/错误提示样式 */
        .content.loading, .content.error {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 12px;
            min-height: 300px;
        }
        .loading {
            color: #409eff;
            font-weight: 500;
        }
        .error {
            color: #f56c6c;
            font-weight: 500;
        }
        .retry-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            background: #409eff;
            color: #fff;
            cursor: pointer;
            font-family: inherit;
            transition: background 0.2s;
        }
        .retry-btn:hover {
            background: #66b1ff;
        }
        /* 移动端适配 */
        @media (max-width: 768px) {
            body {
                padding: 12px;
            }
            h1 {
                font-size: 22px;
                margin-bottom: 16px;
            }
            .content {
                padding: 16px;
                font-size: 15px;
                max-height: 65vh;
            }
            .page-btn {
                min-width: 44px;
                padding: 6px 12px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>中医书籍搜集展示</h1>
    </header>
    
    <main>
        <!-- 编码切换区域 -->
        <div class="encoding-switch">
            <label for="encoding">文本编码：</label>
            <select id="encoding">
                <option value="utf-8">UTF-8</option>
                <option value="gbk">GBK/GB2312（中文古籍常用）</option>
            </select>
        </div>

        <!-- 分页按钮区域 -->
        <div class="pagination" id="pagination"></div>
        
        <!-- 内容展示容器 -->
        <div class="content" id="txtContent"></div>
    </main>

    <script>
        // 用IIFE包裹，避免全局变量污染
        (function() {
            // 1. 配置项（集中管理，后续修改无需动业务逻辑）
            const CONFIG = {
                txtFiles: [
                    'content_01.txt', 'content_02.txt', 'content_03.txt',
                    'content_04.txt', 'content_05.txt', 'content_06.txt',
                    'content_07.txt', 'content_08.txt', 'content_09.txt',
                    'content_10.txt', 'content_11.txt', 'content_12.txt'
                ],
                defaultEncoding: 'utf-8',
                pageHashPrefix: '#page='
            };

            // 2. 全局状态（仅在闭包内访问）
            let currentPage = 0;
            let currentReader = null;
            let currentEncoding = CONFIG.defaultEncoding;

            // 3. DOM元素缓存
            const paginationEl = document.getElementById('pagination');
            const contentEl = document.getElementById('txtContent');
            const encodingSelect = document.getElementById('encoding');

            // 4. 生成分页按钮
            function createPagination() {
                CONFIG.txtFiles.forEach((_, index) => {
                    const pageNum = index + 1;
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = `page-btn ${index === currentPage ? 'active' : ''}`;
                    btn.textContent = `第${pageNum}页`;
                    btn.setAttribute('aria-label', `切换到第${pageNum}页`);
                    btn.setAttribute('aria-current', index === currentPage ? 'page' : 'false');
                    // 点击按钮切换页码
                    btn.addEventListener('click', () => switchPage(index));
                    paginationEl.appendChild(btn);
                });
            }

            // 5. 更新按钮激活状态
            function updateActiveBtn(pageIndex) {
                document.querySelectorAll('.page-btn').forEach((btn, idx) => {
                    const isActive = idx === pageIndex;
                    btn.classList.toggle('active', isActive);
                    btn.setAttribute('aria-current', isActive ? 'page' : 'false');
                });
            }

            // 6. 核心：切换页码并流式加载txt文件
            async function switchPage(pageIndex, isHashChange = false) {
                // 边界判断：页码超出范围直接返回
                if (pageIndex < 0 || pageIndex >= CONFIG.txtFiles.length) return;
                // 重复点击当前页，直接返回，避免重复请求
                if (pageIndex === currentPage && !isHashChange) return;

                // 中断上一次未完成的流式读取
                if (currentReader) {
                    currentReader.cancel('用户切换了页码');
                    currentReader = null;
                }

                // 更新当前页码和按钮状态
                currentPage = pageIndex;
                updateActiveBtn(pageIndex);

                // 更新URL hash，实现状态持久化（避免hashchange循环触发）
                if (!isHashChange) {
                    window.history.replaceState(null, '', `${CONFIG.pageHashPrefix}${pageIndex + 1}`);
                }

                // 显示加载状态
                contentEl.className = 'content loading';
                contentEl.innerHTML = `正在加载第${pageIndex + 1}页内容...<br>（文件较大，内容将逐步显示）`;

                try {
                    // 加载对应txt文件
                    const response = await fetch(CONFIG.txtFiles[pageIndex]);
                    if (!response.ok) {
                        throw new Error(`第${pageIndex + 1}页文件未找到或加载失败，请检查文件是否存在`);
                    }

                    // 获取流式读取器
                    const reader = response.body.getReader();
                    currentReader = reader;
                    // 文本解码器（适配用户选择的编码）
                    const decoder = new TextDecoder(currentEncoding);
                    
                    // 清空加载提示，准备展示流式内容
                    contentEl.className = 'content';
                    contentEl.textContent = '';

                    // 循环读取文件块
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        // 解码二进制块为字符串
                        const chunk = decoder.decode(value, { stream: true });
                        contentEl.textContent += chunk;

                        // 优化：仅当用户滚动条在底部时，才自动跟随滚动
                        const isScrollAtBottom = contentEl.scrollTop + contentEl.clientHeight >= contentEl.scrollHeight - 20;
                        if (isScrollAtBottom) {
                            contentEl.scrollTop = contentEl.scrollHeight;
                        }
                    }

                    // 读取完成，清空读取器标识
                    currentReader = null;
                } catch (error) {
                    // 过滤主动中断的错误，只提示真实加载失败
                    if (error.message !== '用户切换了页码') {
                        contentEl.className = 'content error';
                        contentEl.innerHTML = `加载失败：${error.message}<br><button class="retry-btn" id="retryBtn">重新加载</button>`;
                        // 绑定重试按钮事件
                        document.getElementById('retryBtn').addEventListener('click', () => switchPage(pageIndex));
                    }
                }
            }

            // 7. 从URL hash中读取页码
            function getPageFromHash() {
                const hash = window.location.hash;
                if (!hash.startsWith(CONFIG.pageHashPrefix)) return 0;
                const pageNum = parseInt(hash.replace(CONFIG.pageHashPrefix, ''), 10);
                // 页码合法性判断
                if (isNaN(pageNum) || pageNum < 1 || pageNum > CONFIG.txtFiles.length) return 0;
                return pageNum - 1;
            }

            // 8. 页面初始化
            function init() {
                // 从hash中获取初始页码
                currentPage = getPageFromHash();
                // 生成分页按钮
                createPagination();
                // 加载初始页
                switchPage(currentPage, true);

                // 监听编码切换
                encodingSelect.addEventListener('change', (e) => {
                    currentEncoding = e.target.value;
                    // 重新加载当前页
                    switchPage(currentPage);
                });

                // 监听浏览器前进后退，切换页码
                window.addEventListener('hashchange', () => {
                    const targetPage = getPageFromHash();
                    switchPage(targetPage, true);
                });
            }

            // DOM加载完成后立即初始化，无需等待所有资源加载
            document.addEventListener('DOMContentLoaded', init);
        })();
    </script>
</body>
</html>
